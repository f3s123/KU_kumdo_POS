<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table {{ table_num }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='table.css') }}">
    <style>
        a {
            text-decoration: none;
            color: inherit;
        }
        a:hover {
            text-decoration: none;
            color: inherit;
        }
        .row-divider {
            width: 100%;
            height: 20px; /* 원하는 높이로 설정 */
            background-color: transparent; /* 필요에 따라 색상 추가 가능 */
            margin: 20px 0; /* 위아래 여백 추가 */
        }   
    </style>
</head>
<body>
    <header>
        <a href="{{ url_for('main') }}">검도부 주점</a>
    </header>
    <nav>
        <a href="{{ url_for('order_menu_list') }}">주문 목록</a>
        <a href="{{ url_for('takeout') }}">테이크아웃</a>
        <a href="{{ url_for('view_done_orders') }}">완료된 요리</a>
        <a href="{{ url_for('view_payments') }}">결제 상황</a>
    </nav>

    <div class="container">
        <h1>Table {{ table_num }}</h1>
        <div class="menu-grid">
            {% for menu in menus %}
                <div class="menu-item" data-price="{{ menu['price'] }}">
                    <h3>{{ menu['name'] }}</h3>
                    <p>{{ menu['price'] }} won</p>
                    <p class="count">{{ orders.get(menu['name'], 0) }} 개</p>
                    <div class="buttons">
                        <button class="order" onclick="handleOrder('{{ table_num }}', '{{ menu['name'] }}', {{ menu['price'] }})">주문</button>
                        <button class="delete" onclick="handleCancel('{{ table_num }}', '{{ menu['name'] }}', {{ menu['price'] }})">취소</button>
                    </div>
                </div>

            {% endfor %}
        </div>

        <div class="memo-section">
            <h2>메모</h2>
            <textarea id="memo" rows="3" placeholder="메모 입력">{{ memo|default('') }}</textarea>
            <button onclick="saveMemo('{{ table_num }}')">메모 저장</button>
        </div>
        
        <div class="summary">
            <p class="total-price">총 금액: {{ total_price|default(0) }} won</p>
            <p id="elapsed-time">경과 시간: {{ elapsed_time|default('00시 00분 00초') }}</p>
        </div>
        <div class="action-bar">
            <button id="start-timer" onclick="handleStartTimer('{{ table_num }}')">시간 시작</button>
            <button id="complete-order" onclick="handleComplete('{{ table_num }}')">계산 완료</button>
        </div>
    </div>

    <script>
        let timerInterval;
        let elapsedSeconds = {{ elapsed_seconds|default(0) }};
        let startTime = {% if entrance_time and entrance_time != "0" %}"{{ entrance_time }}"{% else %}""{% endif %};

        function formatTime(seconds) {
            const hours = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const secs = String(seconds % 60).padStart(2, '0');
            return `${hours}시 ${minutes}분 ${secs}초`;
        }

        function updateTimer() {
            if (startTime && startTime !== "") {
                try {
                    const start = new Date(startTime);
                    const now = new Date();
                    elapsedSeconds = Math.floor((now - start) / 1000);
                    document.getElementById('elapsed-time').textContent = 
                        '경과 시간: ' + formatTime(elapsedSeconds);
                } catch (error) {
                    console.error('Error updating timer:', error);
                }
            }
        }

        function handleOrder(tableNum, menuName, price) {
            fetch('/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    table_num: tableNum,
                    menu_name: menuName,
                    price: price
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('주문 처리 중 오류가 발생했습니다.');
            });
        }

        function handleCancel(tableNum, menuName, price) {
            fetch('/cancel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    table_num: tableNum,
                    menu_name: menuName,
                    price: price
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('취소 처리 중 오류가 발생했습니다.');
            });
        }

        function handleStartTimer() {
            if (timerInterval || startTime) return;

            fetch(`/start-timer/{{ table_num }}`, { 
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.timestamp) {
                    startTime = data.timestamp;
                    timerInterval = setInterval(updateTimer, 1000);
                    updateTimer();
                } else {
                    throw new Error('Invalid server response');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('타이머 시작 중 오류가 발생했습니다.');
            });
        }

        function handleComplete(tableNum) {
            if (confirm('계산을 완료하시겠습니까?')) {
                clearInterval(timerInterval);
                fetch(`/complete/${tableNum}`, { method: 'POST' })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        alert('계산이 완료되었습니다.');
                        window.location.href = '/';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('계산 처리 중 오류가 발생했습니다.');
                        timerInterval = setInterval(updateTimer, 1000); // 에러 시 타이머 재시작
                    });
            }
        }

        function saveMemo(tableNum) {
            const memo = document.getElementById('memo').value;

            fetch(`/save-memo/${tableNum}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ memo: memo })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                alert('메모가 저장되었습니다.');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('메모 저장 중 오류가 발생했습니다.');
            });
        }

        // 페이지 로드 시 타이머 초기화
        document.addEventListener('DOMContentLoaded', function() {
            if (startTime && startTime !== "") {
                timerInterval = setInterval(updateTimer, 1000);
                updateTimer();
            }
        });
    </script>
</body>
</html>
